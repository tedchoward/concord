!function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a="function"==typeof require&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);throw new Error("Cannot find module '"+o+"'")}var f=n[o]={exports:{}};t[o][0].call(f.exports,function(e){var n=t[o][1][e];return s(n?n:e)},f,f.exports,e,t,n,r)}return n[o].exports}for(var i="function"==typeof require&&require,o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require){require("./lib/index")},{"./lib/index":9}],2:[function(require,module){function ConcordEditor(root,concordInstance){this.makeNode=function(){var node=$("<li></li>");node.addClass("concord-node");var wrapper=$("<div class='concord-wrapper'></div>"),iconName="caret-right",icon='<i class="node-icon icon-'+iconName+'"></i>';wrapper.append(icon),wrapper.addClass("type-icon");var text=$("<div class='concord-text' contenteditable='true'></div>"),outline=$("<ol></ol>");return text.appendTo(wrapper),wrapper.appendTo(node),outline.appendTo(node),node},this.dragMode=function(){root.data("draggingChange",root.children().clone(!0,!0)),root.addClass("dragging"),root.data("dragging",!0)},this.dragModeExit=function(){root.data("dragging")&&(concordInstance.op.markChanged(),root.data("change",root.data("draggingChange")),root.data("changeTextMode",!1),root.data("changeRange",void 0)),root.find(".draggable").removeClass("draggable"),root.find(".drop-sibling").removeClass("drop-sibling"),root.find(".drop-child").removeClass("drop-child"),root.removeClass("dragging"),root.data("dragging",!1),root.data("mousedown",!1)},this.edit=function(node,empty){var text=node.children(".concord-wrapper:first").children(".concord-text:first");empty&&text.html(""),text.focus();var el=text.get(0);if(el&&el.childNodes&&el.childNodes[0])if("undefined"!=typeof window.getSelection&&"undefined"!=typeof document.createRange){var range=document.createRange();range.selectNodeContents(el),range.collapse(!1);var sel=window.getSelection();sel.removeAllRanges(),sel.addRange(range)}else if("undefined"!=typeof document.body.createTextRange){var textRange=document.body.createTextRange();textRange.moveToElementText(el),textRange.collapse(!1),textRange.select()}text.addClass("editing"),empty||root.find(".concord-node.dirty").length>0&&concordInstance.op.markChanged()},this.editable=function(target){var editable=!1;return target.hasClass("concord-text")||(target=target.parents(".concord-text:first")),1==target.length&&(editable=target.hasClass("concord-text")&&target.hasClass("editing")),editable},this.editorMode=function(){root.find(".selected").removeClass("selected"),root.find(".editing").each(function(){$(this).removeClass("editing")}),root.find(".selection-toolbar").remove()},this.opml=function(_root,flsubsonly){void 0==flsubsonly&&(flsubsonly=!1),_root&&(root=_root);var title=root.data("title");title||(title=root.hasClass("concord-node")?root.children(".concord-wrapper:first").children(".concord-text:first").text():"");var opml='<?xml version="1.0"?>\n';if(opml+='<opml version="2.0">\n',opml+="<head>\n",opml+="<title>"+ConcordUtil.escapeXml(title)+"</title>\n",opml+="</head>\n",opml+="<body>\n",root.hasClass("concord-cursor"))opml+=this.opmlLine(root,0,flsubsonly);else{var editor=this;root.children(".concord-node").each(function(){opml+=editor.opmlLine($(this))})}return opml+="</body>\n",opml+="</opml>\n"},this.opmlLine=function(node,indent,flsubsonly){void 0==indent&&(indent=0),void 0==flsubsonly&&(flsubsonly=!1);var text=this.unescape(node.children(".concord-wrapper:first").children(".concord-text:first").html()),textMatches=text.match(/^(.+)<br>\s*$/);textMatches&&(text=textMatches[1]);for(var opml="",i=0;indent>i;i++)opml+="	";var subheads;if(flsubsonly)subheads=node.children("ol").children(".concord-node");else{opml+='<outline text="'+ConcordUtil.escapeXml(text)+'"';var attributes=node.data("attributes");void 0===attributes&&(attributes={});for(var name in attributes)void 0!==name&&""!=name&&"text"!=name&&void 0!==attributes[name]&&(opml+=" "+name+'="'+ConcordUtil.escapeXml(attributes[name])+'"');if(subheads=node.children("ol").children(".concord-node"),0==subheads.length)return opml+="/>\n";opml+=">\n"}var editor=this;if(indent++,subheads.each(function(){opml+=editor.opmlLine($(this),indent)}),!flsubsonly){for(var i=0;indent>i;i++)opml+="	";opml+="</outline>\n"}return opml},this.textLine=function(node,indent){indent||(indent=0);for(var text="",i=0;indent>i;i++)text+="	";text+=this.unescape(node.children(".concord-wrapper:first").children(".concord-text:first").html()),text+="\n";var editor=this;return node.children("ol").children(".concord-node").each(function(){text+=editor.textLine($(this),indent+1)}),text},this.select=function(node,multiple,multipleRange){if(void 0==multiple&&(multiple=!1),void 0==multipleRange&&(multipleRange=!1),1==node.length){if(this.selectionMode(multiple),multiple&&(node.parents(".concord-node.selected").removeClass("selected"),node.find(".concord-node.selected").removeClass("selected")),multiple&&multipleRange){var prevNodes=node.prevAll(".selected");if(prevNodes.length>0){var stamp=!1;node.prevAll().reverse().each(function(){$(this).hasClass("selected")?stamp=!0:stamp&&$(this).addClass("selected")})}else{var nextNodes=node.nextAll(".selected");if(nextNodes.length>0){var stamp=!0;node.nextAll().each(function(){$(this).hasClass("selected")?stamp=!1:stamp&&$(this).addClass("selected")})}}}var text=node.children(".concord-wrapper:first").children(".concord-text:first");text.hasClass("editing")&&text.removeClass("editing"),node.addClass("selected"),text.text().length>0,this.dragModeExit()}root.find(".concord-node.dirty").length>0&&concordInstance.op.markChanged()},this.selectionMode=function(multiple){void 0==multiple&&(multiple=!1);var node=root.find(".concord-cursor");if(1==node.length){var text=node.children(".concord-wrapper:first").children(".concord-text:first");1==text.length}multiple||root.find(".selected").removeClass("selected"),root.find(".selection-toolbar").remove()},this.build=function(outline,collapsed,level){level||(level=1);var node=$("<li></li>");node.addClass("concord-node"),node.addClass("concord-level-"+level);var attributes={};$(outline[0].attributes).each(function(){"text"!=this.name&&(attributes[this.name]=this.value,"type"==this.name&&node.attr("opml-"+this.name,this.value))}),node.data("attributes",attributes);var wrapper=$("<div class='concord-wrapper'></div>"),nodeIcon=attributes.icon;nodeIcon||(nodeIcon=attributes.type);var iconName="caret-right";nodeIcon&&(nodeIcon==node.attr("opml-type")&&concordInstance.prefs()&&concordInstance.prefs().typeIcons&&concordInstance.prefs().typeIcons[nodeIcon]?iconName=concordInstance.prefs().typeIcons[nodeIcon]:nodeIcon==attributes.icon&&(iconName=nodeIcon));var icon='<i class="node-icon icon-'+iconName+'"></i>';wrapper.append(icon),wrapper.addClass("type-icon"),"true"==attributes.isComment&&node.addClass("concord-comment");var text=$("<div class='concord-text' contenteditable='true'></div>");if(text.addClass("concord-level-"+level+"-text"),text.html(this.escape(outline.attr("text"))),void 0!==attributes.cssTextClass){var cssClasses=attributes.cssTextClass.split(/\s+/);for(var c in cssClasses){var newClass=cssClasses[c];text.addClass(newClass)}}var children=$("<ol></ol>"),editor=this;return outline.children("outline").each(function(){var child=editor.build($(this),collapsed,level+1);child.appendTo(children)}),collapsed&&outline.children("outline").size()>0&&node.addClass("collapsed"),text.appendTo(wrapper),wrapper.appendTo(node),children.appendTo(node),node},this.hideContextMenu=function(){root.data("dropdown")&&(root.data("dropdown").hide(),root.data("dropdown").remove(),root.removeData("dropdown"))},this.showContextMenu=function(x,y){if(concordInstance.prefs().contextMenu){this.hideContextMenu(),root.data("dropdown",$(concordInstance.prefs().contextMenu).clone().appendTo(concordInstance.container));var editor=this;root.data("dropdown").on("click","a",function(){editor.hideContextMenu()}),root.data("dropdown").css({position:"absolute",top:y+"px",left:x+"px",cursor:"default"}),root.data("dropdown").show()}},this.sanitize=function(){root.find(".concord-text.paste").each(function(){var concordText=$(this);if("..."!=concordInstance.pasteBin.text()){var h=concordInstance.pasteBin.html();h=h.replace(new RegExp("<(div|p|blockquote|pre|li|br|dd|dt|code|h\\d)[^>]*(/)?>","gi"),"\n"),h=$("<div/>").html(h).text();var clipboardMatch=!1;if(void 0!==concordClipboard){var trimmedClipboardText=concordClipboard.text.replace(/^[\s\r\n]+|[\s\r\n]+$/g,""),trimmedPasteText=h.replace(/^[\s\r\n]+|[\s\r\n]+$/g,"");if(trimmedClipboardText==trimmedPasteText){var clipboardNodes=concordClipboard.data;if(clipboardNodes){var collapseNode=function(node){node.find("ol").each(function(){$(this).children().length>0&&$(this).parent().addClass("collapsed")})};clipboardNodes.each(function(){collapseNode($(this))}),root.data("clipboard",clipboardNodes),concordInstance.op.setTextMode(!1),concordInstance.op.paste(),clipboardMatch=!0}}}if(!clipboardMatch){concordClipboard=void 0;for(var numberoflines=0,lines=h.split("\n"),i=0;i<lines.length;i++){var line=lines[i];""==line||line.match(/^\s+$/)||numberoflines++}if(!concordInstance.op.inTextMode()||numberoflines>1)concordInstance.op.insertText(h);else{concordInstance.op.saveState(),concordText.focus();var range=concordText.parents(".concord-node:first").data("range");if(range)try{var sel=window.getSelection();sel.removeAllRanges(),sel.addRange(range)}catch(e){console.log(e)}finally{concordText.parents(".concord-node:first").removeData("range")}document.execCommand("insertText",null,h),concordInstance.root.removeData("clipboard"),concordInstance.op.markChanged()}}concordText.removeClass("paste")}})},this.escape=function(s){var h=$("<div/>").text(s).html();if(h=h.replace(/\u00A0/g," "),concordInstance.op.getRenderMode()){var allowedTags=["b","strong","i","em","a","img","strike","del"];for(var tagIndex in allowedTags){var tag=allowedTags[tagIndex];h="img"==tag?h.replace(new RegExp("&lt;"+tag+"((?!&gt;).+)(/)?&gt;","gi"),"<"+tag+"$1/>"):"a"==tag?h.replace(new RegExp("&lt;"+tag+"((?!&gt;).*?)&gt;((?!&lt;/"+tag+"&gt;).+?)&lt;/"+tag+"&gt;","gi"),"<"+tag+"$1>$2</"+tag+">"):h.replace(new RegExp("&lt;"+tag+"&gt;((?!&lt;/"+tag+"&gt;).+?)&lt;/"+tag+"&gt;","gi"),"<"+tag+">$1</"+tag+">")}}return h},this.unescape=function(s){var h=s.replace(/</g,"&lt;").replace(/>/g,"&gt;");return h=$("<div/>").html(h).text()},this.getSelection=function(){var range=void 0;return window.getSelection&&(sel=window.getSelection(),sel.getRangeAt&&sel.rangeCount&&(range=sel.getRangeAt(0),0==$(range.startContainer).parents(".concord-node:first").length&&(range=void 0))),range},this.saveSelection=function(){var range=this.getSelection();return void 0!==range&&concordInstance.op.getCursor().data("range",range.cloneRange()),range},this.restoreSelection=function(range){var cursor=concordInstance.op.getCursor();if(void 0===range&&(range=cursor.data("range")),void 0!==range&&window.getSelection){{cursor.children(".concord-wrapper").children(".concord-text")}try{var cloneRanger=range.cloneRange(),sel=window.getSelection();sel.removeAllRanges(),sel.addRange(cloneRanger)}catch(e){console.log(e)}finally{cursor.removeData("range")}}return range},this.recalculateLevels=function(context){context||(context=root.find(".concord-node")),context.each(function(){var text=$(this).children(".concord-wrapper").children(".concord-text"),levelMatch=$(this).attr("class").match(/.*concord-level-(\d+).*/);levelMatch&&($(this).removeClass("concord-level-"+levelMatch[1]),text.removeClass("concord-level-"+levelMatch[1]+"-text"));var level=$(this).parents(".concord-node").length+1;$(this).addClass("concord-level-"+level),text.addClass("concord-level-"+level+"-text")})}}module.exports=ConcordEditor},{}],3:[function(require,module){function ConcordEvents(root,editor,op,concordInstance){var instance=this;this.wrapperDoubleClick=function(event){if(concord.handleEvents){if(root.data("dropdown"))return void editor.hideContextMenu();if(!editor.editable($(event.target))){var wrapper=$(event.target);if(wrapper.hasClass("node-icon")&&(wrapper=wrapper.parent()),wrapper.hasClass("concord-wrapper")){event.stopPropagation();{wrapper.parents(".concord-node:first")}op.setTextMode(!1),op.subsExpanded()?op.collapse():op.expand()}}}},this.clickSelect=function(event){if(concord.handleEvents){if(root.data("dropdown"))return event.stopPropagation(),void editor.hideContextMenu();if(concord.mobile){var node=$(event.target);if(concordInstance.op.getCursor()[0]===node[0])return void instance.doubleClick(event)}if(1==event.which&&!editor.editable($(event.target))){var node=$(event.target);if(!node.hasClass("concord-node"))return;if(1==node.length){if(event.stopPropagation(),event.shiftKey&&node.parents(".concord-node.selected").length>0)return;op.setTextMode(!1),op.setCursor(node,event.shiftKey||event.metaKey,event.shiftKey)}}}},this.doubleClick=function(event){if(concord.handleEvents){if(root.data("dropdown"))return void editor.hideContextMenu();if(!editor.editable($(event.target))){var node=$(event.target);node.hasClass("concord-node")&&node.hasClass("concord-cursor")&&(event.stopPropagation(),op.setTextMode(!1),op.setCursor(node),op.subsExpanded()?op.collapse():op.expand())}}},this.wrapperClickSelect=function(event){if(concord.handleEvents){if(root.data("dropdown"))return void editor.hideContextMenu();if(concord.mobile){var target=$(event.target),node=target.parents(".concord-node:first");if(concordInstance.op.getCursor()[0]===node[0])return void instance.wrapperDoubleClick(event)}if(1==event.which&&!editor.editable($(event.target))){var wrapper=$(event.target);if(wrapper.hasClass("node-icon")&&(wrapper=wrapper.parent()),wrapper.hasClass("concord-wrapper")){var node=wrapper.parents(".concord-node:first");if(event.shiftKey&&node.parents(".concord-node.selected").length>0)return;op.setTextMode(!1),op.setCursor(node,event.shiftKey||event.metaKey,event.shiftKey)}}}},this.contextmenu=function(event){if(concord.handleEvents){event.preventDefault(),event.stopPropagation();var node=$(event.target);(node.hasClass("concord-wrapper")||node.hasClass("node-icon"))&&op.setTextMode(!1),node.hasClass("concord-node")||(node=node.parents(".concord-node:first")),concordInstance.fireCallback("opContextMenu",op.setCursorContext(node)),op.setCursor(node),editor.showContextMenu(event.pageX,event.pageY)}},root.on("dblclick",".concord-wrapper",this.wrapperDoubleClick),root.on("dblclick",".concord-node",this.doubleClick),root.on("dblclick",".concord-text",function(event){if(concord.handleEvents&&1==concordInstance.prefs().readonly){event.preventDefault(),event.stopPropagation();var node=$(event.target).parents(".concord-node:first");op.setCursor(node),op.subsExpanded()?op.collapse():op.expand()}}),root.on("click",".concord-wrapper",this.wrapperClickSelect),root.on("click",".concord-node",this.clickSelect),root.on("mouseover",".concord-wrapper",function(event){if(concord.handleEvents){var node=$(event.target).parents(".concord-node:first");concordInstance.fireCallback("opHover",op.setCursorContext(node))}}),concordInstance.prefs.contextMenu&&(root.on("contextmenu",".concord-text",this.contextmenu),root.on("contextmenu",".concord-node",this.contextmenu),root.on("contextmenu",".concord-wrapper",this.contextmenu)),root.on("blur",".concord-text",function(){if(concord.handleEvents&&1!=concordInstance.prefs().readonly){$(this).html().match(/^\s*<br>\s*$/)&&$(this).html("");var node=($(this),$(this).parents(".concord-node:first"));concordInstance.op.inTextMode()&&editor.saveSelection(),concordInstance.op.inTextMode()&&node.hasClass("dirty")&&node.removeClass("dirty")}}),root.on("paste",".concord-text",function(){concord.handleEvents&&1!=concordInstance.prefs().readonly&&($(this).addClass("paste"),concordInstance.editor.saveSelection(),concordInstance.pasteBin.html(""),concordInstance.pasteBin.focus(),setTimeout(editor.sanitize,10))}),concordInstance.pasteBin.on("copy",function(){if(concord.handleEvents){var copyText="";root.find(".selected").each(function(){copyText+=concordInstance.editor.textLine($(this))}),""!=copyText&&"\n"!=copyText&&(concordClipboard={text:copyText,data:root.find(".selected").clone(!0,!0)},concordInstance.pasteBin.html("<pre>"+$("<div/>").text(copyText).html()+"</pre>"),concordInstance.pasteBin.focus(),document.execCommand("selectAll"))}}),concordInstance.pasteBin.on("paste",function(){if(concord.handleEvents&&1!=concordInstance.prefs().readonly){var concordText=concordInstance.op.getCursor().children(".concord-wrapper").children(".concord-text");concordText.addClass("paste"),concordInstance.pasteBin.html(""),setTimeout(editor.sanitize,10)}}),concordInstance.pasteBin.on("cut",function(){if(concord.handleEvents&&1!=concordInstance.prefs().readonly){var copyText="";root.find(".selected").each(function(){copyText+=concordInstance.editor.textLine($(this))}),""!=copyText&&"\n"!=copyText&&(concordClipboard={text:copyText,data:root.find(".selected").clone(!0,!0)},concordInstance.pasteBin.html("<pre>"+$("<div/>").text(copyText).html()+"</pre>"),concordInstance.pasteBinFocus()),concordInstance.op.deleteLine(),setTimeout(function(){concordInstance.pasteBinFocus()},200)}}),root.on("mousedown",function(event){if(concord.handleEvents){var target=$(event.target);if(target.is("a"))return void(target.attr("href")&&(event.preventDefault(),window.open(target.attr("href"))));if(1!=concordInstance.prefs().readonly){if(1==event.which){if(root.data("dropdown"))return void editor.hideContextMenu();if(1==target.parents(".concord-text:first").length&&(target=target.parents(".concord-text:first")),target.hasClass("concord-text")){var node=target.parents(".concord-node:first");1==node.length&&(root.hasClass("textMode")||(root.find(".selected").removeClass("selected"),root.addClass("textMode")),node.children(".concord-wrapper").children(".concord-text").hasClass("editing")&&(root.find(".editing").removeClass("editing"),node.children(".concord-wrapper").children(".concord-text").addClass("editing")),node.hasClass("concord-cursor")||(root.find(".concord-cursor").removeClass("concord-cursor"),node.addClass("concord-cursor"),concordInstance.fireCallback("opCursorMoved",op.setCursorContext(node))))}else event.preventDefault(),root.data("mousedown",!0)}}else{event.preventDefault();var target=$(event.target);if(1==target.parents(".concord-text:first").length&&(target=target.parents(".concord-text:first")),target.hasClass("concord-text")){var node=target.parents(".concord-node:first");1==node.length&&op.setCursor(node)}}}}),root.on("mousemove",function(event){if(concord.handleEvents&&1!=concordInstance.prefs().readonly&&!editor.editable($(event.target))&&(event.preventDefault(),root.data("mousedown")&&!root.data("dragging"))){var target=$(event.target);target.hasClass("node-icon")&&(target=target.parent()),target.hasClass("concord-wrapper")&&target.parent().hasClass("selected")&&editor.dragMode()}}),root.on("mouseup",function(event){if(concord.handleEvents&&1!=concordInstance.prefs().readonly){var target=$(event.target);if(target.hasClass("concord-node")?target=target.children(".concord-wrapper:first").children(".concord-text:first"):target.hasClass("concord-wrapper")&&(target=target.children(".concord-text:first")),!editor.editable(target)&&(root.data("mousedown",!1),root.data("dragging"))){var target=$(event.target),node=target.parents(".concord-node:first"),draggable=root.find(".selected");if(1==node.length&&draggable.length>=1){var isDraggableTarget=!1;if(draggable.each(function(){this==node[0]&&(isDraggableTarget=!0)}),isDraggableTarget){var prev=node.prev();if(1==prev.length&&prev.hasClass("drop-child")){var clonedDraggable=draggable.clone(!0,!0),outline=prev.children("ol");clonedDraggable.appendTo(outline),prev.removeClass("collapsed"),draggable.remove()}}else{var draggableIsTargetParent=!1;if(node.parents(".concord-node").each(function(){var nodeParent=$(this)[0];draggable.each(function(){$(this)[0]==nodeParent&&(draggableIsTargetParent=!0)})}),!draggableIsTargetParent)if(target.hasClass("concord-wrapper")||target.hasClass("node-icon")){var clonedDraggable=draggable.clone(!0,!0);clonedDraggable.insertAfter(node),draggable.remove()}else{var clonedDraggable=draggable.clone(!0,!0),outline=node.children("ol");clonedDraggable.prependTo(outline),node.removeClass("collapsed"),draggable.remove()}}}editor.dragModeExit(),concordInstance.editor.recalculateLevels()}}}),root.on("mouseover",function(event){if(concord.handleEvents&&1!=concordInstance.prefs().readonly&&root.data("dragging")){event.preventDefault();var target=$(event.target),node=target.parents(".concord-node:first"),draggable=root.find(".selected");if(1==node.length&&draggable.length>=1){var isDraggableTarget=!1;if(draggable.each(function(){this==node[0]&&(isDraggableTarget=!0)}),isDraggableTarget){if(1==draggable.length){var prev=node.prev();1==prev.length&&(prev.removeClass("drop-sibling").remove("drop-child"),prev.addClass("drop-child"))}}else{var draggableIsTargetParent=!1;node.parents(".concord-node").each(function(){var nodeParent=$(this)[0];draggable.each(function(){$(this)[0]==nodeParent&&(draggableIsTargetParent=!0)})}),draggableIsTargetParent||(node.removeClass("drop-sibling").remove("drop-child"),node.addClass(target.hasClass("concord-wrapper")||target.hasClass("node-icon")?"drop-sibling":"drop-child"))}}}}),root.on("mouseout",function(){concord.handleEvents&&1!=concordInstance.prefs().readonly&&root.data("dragging")&&(root.find(".drop-sibling").removeClass("drop-sibling"),root.find(".drop-child").removeClass("drop-child"))})}var concord=require("./concord");module.exports=ConcordEvents},{"./concord":8}],4:[function(require,module){function ConcordOpAttributes(concordInstance,cursor){this._cssTextClassName="cssTextClass",this._cssTextClass=function(newValue){if(void 0!==newValue){var newCssClasses=newValue.split(/\s+/),concordText=cursor.children(".concord-wrapper:first").children(".concord-text:first"),currentCssClass=concordText.attr("class");if(currentCssClass){var cssClassesArray=currentCssClass.split(/\s+/);for(var i in cssClassesArray){var className=cssClassesArray[i];null==className.match(/^concord\-.+$/)&&concordText.removeClass(className)}}for(var j in newCssClasses){var newClass=newCssClasses[j];concordText.addClass(newClass)}}},this.addGroup=function(attributes){attributes.type?cursor.attr("opml-type",attributes.type):cursor.removeAttr("opml-type"),this._cssTextClass(attributes[this._cssTextClassName]);var finalAttributes=this.getAll(),iconAttribute="type";attributes.icon&&(iconAttribute="icon");for(var name in attributes)if(finalAttributes[name]=attributes[name],name==iconAttribute){var value=attributes[name],wrapper=cursor.children(".concord-wrapper"),iconName=null;if("type"==name&&concordInstance.prefs()&&concordInstance.prefs().typeIcons&&concordInstance.prefs().typeIcons[value]?iconName=concordInstance.prefs().typeIcons[value]:"icon"==name&&(iconName=value),iconName){var icon='<i class="node-icon icon-'+iconName+'"></i>';wrapper.children(".node-icon:first").replaceWith(icon)}}return cursor.data("attributes",finalAttributes),concordInstance.op.markChanged(),finalAttributes},this.setGroup=function(attributes){this._cssTextClass(void 0!==attributes[this._cssTextClassName]?attributes[this._cssTextClassName]:""),cursor.data("attributes",attributes);var wrapper=cursor.children(".concord-wrapper");$(cursor[0].attributes).each(function(){var matches=this.name.match(/^opml-(.+)$/);if(matches){var name=matches[1];attributes[name]||cursor.removeAttr(this.name)}});var iconAttribute="type";attributes.icon&&(iconAttribute="icon"),"type"==name&&cursor.attr("opml-"+name,attributes[name]);for(var name in attributes)if(name==iconAttribute){var value=attributes[name],wrapper=cursor.children(".concord-wrapper"),iconName=null;if("type"==name&&concordInstance.prefs()&&concordInstance.prefs().typeIcons&&concordInstance.prefs().typeIcons[value]?iconName=concordInstance.prefs().typeIcons[value]:"icon"==name&&(iconName=value),iconName){var icon='<i class="node-icon icon-'+iconName+'"></i>';wrapper.children(".node-icon:first").replaceWith(icon)}}return concordInstance.op.markChanged(),attributes},this.getAll=function(){return void 0!==cursor.data("attributes")?cursor.data("attributes"):{}},this.getOne=function(name){return this.getAll()[name]},this.makeEmpty=function(){this._cssTextClass("");var numAttributes=0,atts=this.getAll();if(void 0!==atts)for(var i in atts)numAttributes++;cursor.removeData("attributes");var removedAnyAttributes=numAttributes>0;return $(cursor[0].attributes).each(function(){var matches=this.name.match(/^opml-(.+)$/);matches&&cursor.removeAttr(this.name)}),removedAnyAttributes&&concordInstance.op.markChanged(),removedAnyAttributes},this.setOne=function(name,value){name==this._cssTextClassName&&this._cssTextClass(value);var atts=this.getAll();if(atts[name]=value,cursor.data("attributes",atts),"type"==name||"icon"==name){cursor.attr("opml-"+name,value);var wrapper=cursor.children(".concord-wrapper"),iconName=null;if("type"==name&&concordInstance.prefs()&&concordInstance.prefs().typeIcons&&concordInstance.prefs().typeIcons[value]?iconName=concordInstance.prefs().typeIcons[value]:"icon"==name&&(iconName=value),iconName){var icon='<i class="node-icon icon-'+iconName+'"></i>';wrapper.children(".node-icon:first").replaceWith(icon)}}return concordInstance.op.markChanged(),!0},this.exists=function(name){return void 0!==this.getOne(name)?!0:!1},this.removeOne=function(name){return this.getAll()[name]?(name==this._cssTextClassName&&this._cssTextClass(""),delete this.getAll()[name],concordInstance.op.markChanged(),!0):!1}}module.exports=ConcordOpAttributes},{}],5:[function(require,module,exports){function ConcordOp(root,concordInstance,_cursor){this._walk_up=function(context){var prev=context.prev();if(0==prev.length){var parent=context.parents(".concord-node:first");return 1==parent.length?parent:null}return this._last_child(prev)},this._walk_down=function(context){var next=context.next();if(1==next.length)return next;var parent=context.parents(".concord-node:first");return 1==parent.length?this._walk_down(parent):null},this._last_child=function(context){if(context.hasClass("collapsed"))return context;var outline=context.children("ol");if(0==outline.length)return context;var lastChild=outline.children(".concord-node:last");return 1==lastChild.length?this._last_child(lastChild):context},this.bold=function(){this.saveState(),this.inTextMode()?document.execCommand("bold"):(this.focusCursor(),document.execCommand("selectAll"),document.execCommand("bold"),document.execCommand("unselect"),this.blurCursor(),concordInstance.pasteBinFocus()),this.markChanged()},this.changed=function(){return 1==root.data("changed")},this.clearChanged=function(){return root.data("changed",!1),!0},this.collapse=function(triggerCallbacks){void 0==triggerCallbacks&&(triggerCallbacks=!0);var node=this.getCursor();1==node.length&&(triggerCallbacks&&concordInstance.fireCallback("opCollapse",this.setCursorContext(node)),node.addClass("collapsed"),node.find("ol").each(function(){$(this).children().length>0&&$(this).parent().addClass("collapsed")}),this.markChanged())},this.copy=function(){this.inTextMode()||root.data("clipboard",root.find(".selected").clone(!0,!0))},this.countSubs=function(){var node=this.getCursor();return 1==node.length?node.children("ol").children().size():0},this.cursorToXml=function(){return concordInstance.editor.opml(this.getCursor())},this.cursorToXmlSubsOnly=function(){return concordInstance.editor.opml(this.getCursor(),!0)},this.cut=function(){this.inTextMode()||(this.copy(),this.deleteLine())},this.deleteLine=function(){if(this.saveState(),this.inTextMode()){var cursor=this.getCursor(),p=cursor.prev();0==p.length&&(p=cursor.parents(".concord-node:first")),cursor.remove(),1==p.length?this.setCursor(p):1==root.find(".concord-node:first").length?this.setCursor(root.find(".concord-node:first")):this.wipe()}else{var selected=root.find(".selected");if(1==selected.length){var p=selected.prev();0==p.length&&(p=selected.parents(".concord-node:first")),selected.remove(),1==p.length?this.setCursor(p):1==root.find(".concord-node:first").length?this.setCursor(root.find(".concord-node:first")):this.wipe()}else if(selected.length>1){var first=root.find(".selected:first"),p=first.prev();0==p.length&&(p=first.parents(".concord-node:first")),selected.each(function(){$(this).remove()}),1==p.length?this.setCursor(p):1==root.find(".concord-node:first").length?this.setCursor(root.find(".concord-node:first")):this.wipe()}}if(0==root.find(".concord-node").length){var node=this.insert("",down);this.setCursor(node)}this.markChanged()},this.deleteSubs=function(){var node=this.getCursor();1==node.length&&node.children("ol").children().length>0&&(this.saveState(),node.children("ol").empty()),this.markChanged()},this.demote=function(){var node=this.getCursor();node.nextAll().length>0&&(this.saveState(),node.nextAll().each(function(){var sibling=$(this).clone(!0,!0);$(this).remove(),sibling.appendTo(node.children("ol")),node.removeClass("collapsed")}),concordInstance.editor.recalculateLevels(node.find(".concord-node")),this.markChanged())},this.expand=function(triggerCallbacks){void 0==triggerCallbacks&&(triggerCallbacks=!0);var node=this.getCursor();if(1==node.length){if(triggerCallbacks&&concordInstance.fireCallback("opExpand",this.setCursorContext(node)),!node.hasClass("collapsed"))return;node.removeClass("collapsed");var cursorPosition=node.offset().top,cursorHeight=node.height(),windowPosition=$(window).scrollTop(),windowHeight=$(window).height();if(windowPosition>cursorPosition||cursorPosition+cursorHeight>windowPosition+windowHeight)if(windowPosition>cursorPosition)$(window).scrollTop(cursorPosition);else if(cursorPosition+cursorHeight>windowPosition+windowHeight){var lineHeight=parseInt(node.children(".concord-wrapper").children(".concord-text").css("line-height"))+6;$(window).scrollTop(windowHeight>cursorHeight+lineHeight?cursorPosition-(windowHeight-cursorHeight)+lineHeight:cursorPosition)}this.markChanged()}},this.expandAllLevels=function(){var node=this.getCursor();1==node.length&&(node.removeClass("collapsed"),node.find(".concord-node").removeClass("collapsed"))},this.focusCursor=function(){this.getCursor().children(".concord-wrapper").children(".concord-text").focus()},this.blurCursor=function(){this.getCursor().children(".concord-wrapper").children(".concord-text").blur()},this.fullCollapse=function(){root.find(".concord-node").each(function(){$(this).children("ol").children().size()>0&&$(this).addClass("collapsed")});var cursor=this.getCursor(),topParent=cursor.parents(".concord-node:last");1==topParent.length&&concordInstance.editor.select(topParent)},this.fullExpand=function(){root.find(".concord-node").removeClass("collapsed")},this.getCursor=function(){return _cursor?_cursor:root.find(".concord-cursor:first")},this.getCursorRef=function(){return this.setCursorContext(this.getCursor())},this.getHeaders=function(){var headers={};return root.data("head")&&(headers=root.data("head")),headers.title=this.getTitle(),headers},this.getLineText=function(){var node=this.getCursor();if(1==node.length){var text=node.children(".concord-wrapper:first").children(".concord-text:first").html(),textMatches=text.match(/^(.+)<br>\s*$/);return textMatches&&(text=textMatches[1]),concordInstance.editor.unescape(text)}return null},this.getRenderMode=function(){return void 0!==root.data("renderMode")?root.data("renderMode")===!0:!0},this.getTitle=function(){return root.data("title")},this.go=function(direction,count,multiple,textMode){void 0===count&&(count=1);var cursor=this.getCursor();void 0==textMode&&(textMode=!1),this.setTextMode(textMode);var ableToMoveInDirection=!1;switch(direction){case up:for(var i=0;count>i;i++){var prev=cursor.prev();if(1!=prev.length)break;cursor=prev,ableToMoveInDirection=!0}this.setCursor(cursor,multiple);
break;case down:for(var i=0;count>i;i++){var next=cursor.next();if(1!=next.length)break;cursor=next,ableToMoveInDirection=!0}this.setCursor(cursor,multiple);break;case left:for(var i=0;count>i;i++){var parent=cursor.parents(".concord-node:first");if(1!=parent.length)break;cursor=parent,ableToMoveInDirection=!0}this.setCursor(cursor,multiple);break;case right:for(var i=0;count>i;i++){var firstSibling=cursor.children("ol").children(".concord-node:first");if(1!=firstSibling.length)break;cursor=firstSibling,ableToMoveInDirection=!0}this.setCursor(cursor,multiple);break;case flatup:for(var nodeCount=0;cursor&&count>nodeCount;){var cursor=this._walk_up(cursor);if(cursor&&!cursor.hasClass("collapsed")&&cursor.children("ol").children().size()>0&&(nodeCount++,ableToMoveInDirection=!0,nodeCount==count)){this.setCursor(cursor,multiple);break}}break;case flatdown:for(var nodeCount=0;cursor&&count>nodeCount;){var next=null;if(!cursor.hasClass("collapsed")){var outline=cursor.children("ol");if(1==outline.length){var firstChild=outline.children(".concord-node:first");1==firstChild.length&&(next=firstChild)}}next||(next=this._walk_down(cursor)),cursor=next,cursor&&!cursor.hasClass("collapsed")&&cursor.children("ol").children().size()>0&&(nodeCount++,ableToMoveInDirection=!0,nodeCount==count&&this.setCursor(cursor,multiple))}}return this.markChanged(),ableToMoveInDirection},this.insert=function(insertText,insertDirection){this.saveState();var level=this.getCursor().parents(".concord-node").length+1,node=$("<li></li>");switch(node.addClass("concord-node"),insertDirection){case right:level+=1;break;case left:level-=1}node.addClass("concord-level-"+level);var wrapper=$("<div class='concord-wrapper'></div>"),iconName="caret-right",icon='<i class="node-icon icon-'+iconName+'"></i>';wrapper.append(icon),wrapper.addClass("type-icon");var text=$("<div class='concord-text' contenteditable='true'></div>");text.addClass("concord-level-"+level+"-text");var outline=$("<ol></ol>");text.appendTo(wrapper),wrapper.appendTo(node),outline.appendTo(node),insertText&&""!=insertText&&text.html(concordInstance.editor.escape(insertText));var cursor=this.getCursor();switch(insertDirection||(insertDirection=down),insertDirection){case down:cursor.after(node);break;case right:cursor.children("ol").prepend(node),this.expand(!1);break;case up:cursor.before(node);break;case left:var parent=cursor.parents(".concord-node:first");1==parent.length&&parent.after(node)}return this.setCursor(node),this.markChanged(),concordInstance.fireCallback("opInsert",this.setCursorContext(node)),node},this.insertImage=function(url){this.inTextMode()?document.execCommand("insertImage",null,url):this.insert('<img src="'+url+'">',down)},this.insertText=function(text){for(var nodes=$("<ol></ol>"),lastLevel=0,startingline=0,startinglevel=0,lastNode=null,parent=null,parents={},lines=text.split("\n"),workflowy=!0,workflowyParent=null,firstlinewithcontent=0,i=0;i<lines.length;i++){var line=lines[i];if(!line.match(/^\s*$/)){firstlinewithcontent=i;break}}if(lines.length>firstlinewithcontent+2&&null==lines[firstlinewithcontent].match(/^([\t\s]*)\-.*$/)&&lines[firstlinewithcontent].match(/^.+$/)&&""==lines[firstlinewithcontent+1]){startingline=firstlinewithcontent+2;var workflowyParent=concordInstance.editor.makeNode();workflowyParent.children(".concord-wrapper").children(".concord-text").html(lines[firstlinewithcontent])}for(var i=startingline;i<lines.length;i++){var line=lines[i];if(""!=line&&!line.match(/^\s+$/)&&null==line.match(/^([\t\s]*)\-.*$/)){workflowy=!1;break}}workflowy||(startingline=0,workflowyParent=null);for(var i=startingline;i<lines.length;i++){var line=lines[i];if(""!=line&&!line.match(/^\s+$/)){var matches=line.match(/^([\t\s]*)(.+)$/),node=concordInstance.editor.makeNode(),nodeText=concordInstance.editor.escape(matches[2]);if(workflowy){var nodeTextMatches=nodeText.match(/^([\t\s]*)\-\s*(.+)$/);null!=nodeTextMatches&&(nodeText=nodeTextMatches[2])}node.children(".concord-wrapper").children(".concord-text").html(nodeText);var level=startinglevel;matches[1]&&(level=workflowy?matches[1].length/2+startinglevel:matches[1].length+startinglevel,level>lastLevel?(parents[lastLevel]=lastNode,parent=lastNode):level>0&&lastLevel>level&&(parent=parents[level-1])),parent&&level>0?(parent.children("ol").append(node),parent.addClass("collapsed")):(parents={},nodes.append(node)),lastNode=node,lastLevel=level}}if(workflowyParent){nodes.children().length>0&&workflowyParent.addClass("collapsed");var clonedNodes=nodes.clone();clonedNodes.children().appendTo(workflowyParent.children("ol")),nodes=$("<ol></ol>"),nodes.append(workflowyParent)}if(nodes.children().length>0){this.saveState(),this.setTextMode(!1);var cursor=this.getCursor();nodes.children().insertAfter(cursor),this.setCursor(cursor.next()),concordInstance.root.removeData("clipboard"),this.markChanged(),concordInstance.editor.recalculateLevels()}},this.insertXml=function(opmltext,dir){this.saveState();var doc=null,nodes=$("<ol></ol>"),cursor=this.getCursor(),level=cursor.parents(".concord-node").length+1;switch(dir||(dir=down),dir){case right:level+=1;break;case left:level-=1}doc=$("string"==typeof opmltext?$.parseXML(opmltext):opmltext),doc.find("body").children("outline").each(function(){nodes.append(concordInstance.editor.build($(this),!0,level))});var expansionState=doc.find("expansionState");if(expansionState&&expansionState.text()&&""!=expansionState.text()){var expansionStates=expansionState.text().split(","),nodeId=1;nodes.find(".concord-node").each(function(){expansionStates.indexOf(""+nodeId)>=0&&$(this).removeClass("collapsed"),nodeId++})}switch(dir){case down:nodes.children().insertAfter(cursor);break;case right:nodes.children().prependTo(cursor.children("ol")),this.expand(!1);break;case up:nodes.children().insertBefore(cursor);break;case left:var parent=cursor.parents(".concord-node:first");1==parent.length&&nodes.children().insertAfter(parent)}return this.markChanged(),!0},this.inTextMode=function(){return root.hasClass("textMode")},this.italic=function(){this.saveState(),this.inTextMode()?document.execCommand("italic"):(this.focusCursor(),document.execCommand("selectAll"),document.execCommand("italic"),document.execCommand("unselect"),this.blurCursor(),concordInstance.pasteBinFocus()),this.markChanged()},this.level=function(){return this.getCursor().parents(".concord-node").length+1},this.link=function(url){if(this.inTextMode()){if(!concord.handleEvents){var instance=this;return void concord.onResume(function(){instance.link(url)})}var range=concordInstance.editor.getSelection();void 0===range&&concordInstance.editor.restoreSelection(),concordInstance.editor.getSelection()&&(this.saveState(),document.execCommand("createLink",null,url),this.markChanged())}},this.markChanged=function(){return root.data("changed",!0),this.inTextMode()||root.find(".concord-node.dirty").removeClass("dirty"),!0},this.paste=function(){if(!this.inTextMode()&&null!=root.data("clipboard")){var pasteNodes=root.data("clipboard").clone(!0,!0);pasteNodes.length>0&&(this.saveState(),root.find(".selected").removeClass("selected"),pasteNodes.insertAfter(this.getCursor()),this.setCursor($(pasteNodes[0]),pasteNodes.length>1),this.markChanged())}},this.promote=function(){var node=this.getCursor();node.children("ol").children().length>0&&(this.saveState(),node.children("ol").children().reverse().each(function(){var child=$(this).clone(!0,!0);$(this).remove(),node.after(child)}),concordInstance.editor.recalculateLevels(node.parent().find(".concord-node")),this.markChanged())},this.redraw=function(){var ct=1,cursorIndex=1,wasChanged=this.changed();root.find(".concord-node:visible").each(function(){return $(this).hasClass("concord-cursor")?(cursorIndex=ct,!1):void ct++}),this.xmlToOutline(this.outlineToXml()),ct=1;var thisOp=this;root.find(".concord-node:visible").each(function(){return cursorIndex==ct?(thisOp.setCursor($(this)),!1):void ct++}),wasChanged&&this.markChanged()},this.reorg=function(direction,count){void 0===count&&(count=1);var ableToMoveInDirection=!1,cursor=this.getCursor(),toMove=this.getCursor(),selected=root.find(".selected"),iteration=1;switch(selected.length>1&&(cursor=root.find(".selected:first"),toMove=root.find(".selected")),direction){case up:var prev=cursor.prev();if(1==prev.length){for(;count>iteration&&1==prev.prev().length;)prev=prev.prev(),iteration++;this.saveState();var clonedMove=toMove.clone(!0,!0);toMove.remove(),clonedMove.insertBefore(prev),ableToMoveInDirection=!0}break;case down:this.inTextMode()||(cursor=root.find(".selected:last"));var next=cursor.next();if(1==next.length){for(;count>iteration&&1==next.next().length;)next=next.next(),iteration++;this.saveState();var clonedMove=toMove.clone(!0,!0);toMove.remove(),clonedMove.insertAfter(next),ableToMoveInDirection=!0}break;case left:var outline=cursor.parent();if(!outline.hasClass("concord-root")){for(var parent=outline.parent();count>iteration;){var parentParent=parent.parents(".concord-node:first");if(1!=parentParent.length)break;parent=parentParent,iteration++}this.saveState();var clonedMove=toMove.clone(!0,!0);toMove.remove(),clonedMove.insertAfter(parent),concordInstance.editor.recalculateLevels(parent.nextAll(".concord-node")),ableToMoveInDirection=!0}break;case right:var prev=cursor.prev();if(1==prev.length){for(this.saveState();count>iteration&&1==prev.children("ol").length;){var prevNode=prev.children("ol").children(".concord-node:last");if(1!=prevNode.length)break;prev=prevNode,iteration++}var prevOutline=prev.children("ol");0==prevOutline.length&&(prevOutline=$("<ol></ol>"),prevOutline.appendTo(prev));var clonedMove=toMove.clone(!0,!0);toMove.remove(),clonedMove.appendTo(prevOutline),prev.removeClass("collapsed"),concordInstance.editor.recalculateLevels(prev.find(".concord-node")),ableToMoveInDirection=!0}}return ableToMoveInDirection&&(this.inTextMode()&&this.setCursor(this.getCursor()),this.markChanged()),ableToMoveInDirection},this.runSelection=function(){var value=eval(this.getLineText());this.deleteSubs(),this.insert(value,"right"),concordInstance.script.makeComment(),this.go("left",1)},this.saveState=function(){if(root.data("change",root.children().clone(!0,!0)),root.data("changeTextMode",this.inTextMode()),this.inTextMode()){var range=concordInstance.editor.getSelection();range?root.data("changeRange",range.cloneRange()):root.data("changeRange",void 0)}else root.data("changeRange",void 0);return!0},this.setCursor=function(node,multiple,multipleRange){root.find(".concord-cursor").removeClass("concord-cursor"),node.addClass("concord-cursor"),this.inTextMode()?concordInstance.editor.edit(node):(concordInstance.editor.select(node,multiple,multipleRange),concordInstance.pasteBinFocus()),concordInstance.fireCallback("opCursorMoved",this.setCursorContext(node)),concordInstance.editor.hideContextMenu()},this.setCursorContext=function(cursor){return new ConcordOp(root,concordInstance,cursor)},this.setHeaders=function(headers){root.data("head",headers),this.markChanged()},this.setLineText=function(text){this.saveState();var node=this.getCursor();return 1==node.length?(node.children(".concord-wrapper:first").children(".concord-text:first").html(concordInstance.editor.escape(text)),!0):!1},this.setRenderMode=function(mode){return root.data("renderMode",mode),this.redraw(),!0},this.setStyle=function(css){return root.parent().find("style.customStyle").remove(),root.before('<style type="text/css" class="customStyle">'+css+"</style>"),!0},this.setTextMode=function(textMode){var readonly=concordInstance.prefs().readonly;void 0==readonly&&(readonly=!1),readonly||root.hasClass("textMode")!=textMode&&(1==textMode?(root.addClass("textMode"),concordInstance.editor.editorMode(),concordInstance.editor.edit(this.getCursor())):(root.removeClass("textMode"),root.find(".editing").removeClass("editing"),this.blurCursor(),concordInstance.editor.select(this.getCursor())))},this.setTitle=function(title){return root.data("title",title),!0},this.strikethrough=function(){this.saveState(),this.inTextMode()?document.execCommand("strikeThrough"):(this.focusCursor(),document.execCommand("selectAll"),document.execCommand("strikeThrough"),document.execCommand("unselect"),this.blurCursor(),concordInstance.pasteBinFocus()),this.markChanged()},this.subsExpanded=function(){var node=this.getCursor();return 1==node.length&&!node.hasClass("collapsed")&&node.children("ol").children().size()>0?!0:!1},this.outlineToText=function(){var text="";return root.children(".concord-node").each(function(){text+=concordInstance.editor.textLine($(this))}),text},this.outlineToXml=function(ownerName,ownerEmail,ownerId){var head=this.getHeaders();ownerName&&(head.ownerName=ownerName),ownerEmail&&(head.ownerEmail=ownerEmail),ownerId&&(head.ownerId=ownerId);var title=this.getTitle();title||(title=""),head.title=title,head.dateModified=(new Date).toGMTString();var expansionStates=[],nodeId=1,cursor=root.find(".concord-node:first");do{if(!cursor)break;!cursor.hasClass("collapsed")&&cursor.children("ol").children().size()>0&&expansionStates.push(nodeId),nodeId++;var next=null;if(!cursor.hasClass("collapsed")){var outline=cursor.children("ol");if(1==outline.length){var firstChild=outline.children(".concord-node:first");1==firstChild.length&&(next=firstChild)}}next||(next=this._walk_down(cursor)),cursor=next}while(null!=cursor);head.expansionState=expansionStates.join(",");var opml="",indent=0,add=function(s){for(var i=0;indent>i;i++)opml+="	";opml+=s+"\n"};add('<?xml version="1.0"?>'),add('<opml version="2.0">'),indent++,add("<head>"),indent++;for(var headName in head)void 0!==head[headName]&&add("<"+headName+">"+ConcordUtil.escapeXml(head[headName])+"</"+headName+">");return add("</head>"),indent--,add("<body>"),indent++,root.children(".concord-node").each(function(){opml+=concordInstance.editor.opmlLine($(this),indent)}),add("</body>"),indent--,add("</opml>"),opml},this.undo=function(){var stateBeforeChange=root.children().clone(!0,!0),textModeBeforeChange=this.inTextMode(),beforeRange=void 0;if(this.inTextMode()){var range=concordInstance.editor.getSelection();range&&(beforeRange=range.cloneRange())}if(root.data("change")){if(root.empty(),root.data("change").appendTo(root),this.setTextMode(root.data("changeTextMode")),this.inTextMode()){this.focusCursor();var range=root.data("changeRange");range&&concordInstance.editor.restoreSelection(range)}return root.data("change",stateBeforeChange),root.data("changeTextMode",textModeBeforeChange),root.data("changeRange",beforeRange),!0}return!1},this.visitLevel=function(cb){var cursor=this.getCursor(),op=this;return cursor.children("ol").children().each(function(){var subCursorContext=op.setCursorContext($(this));cb(subCursorContext)}),!0},this.visitToSummit=function(cb){for(var cursor=this.getCursor();cb(this.setCursorContext(cursor));){var parent=cursor.parents(".concord-node:first");if(1!=parent.length)break;cursor=parent}return!0},this.visitAll=function(cb){var op=this;root.find(".concord-node").each(function(){var subCursorContext=op.setCursorContext($(this)),retVal=cb(subCursorContext);return void 0!==retVal&&retVal===!1?!1:void 0})},this.wipe=function(){root.find(".concord-node").length>0&&this.saveState(),root.empty();var node=concordInstance.editor.makeNode();root.append(node),this.setTextMode(!1),this.setCursor(node),this.markChanged()},this.xmlToOutline=function(xmlText,flSetFocus){void 0==flSetFocus&&(flSetFocus=!0);var doc=null;doc=$("string"==typeof xmlText?$.parseXML(xmlText):xmlText),root.empty();var title="";1==doc.find("title:first").length&&(title=doc.find("title:first").text()),this.setTitle(title);var headers={};doc.find("head").children().each(function(){headers[$(this).prop("tagName")]=$(this).text()}),root.data("head",headers),doc.find("body").children("outline").each(function(){root.append(concordInstance.editor.build($(this),!0))}),root.data("changed",!1),root.removeData("previousChange");var expansionState=doc.find("expansionState");if(expansionState&&expansionState.text()&&""!=expansionState.text()){var expansionStates=expansionState.text().split(/\s*,\s*/),nodeId=1,cursor=root.find(".concord-node:first");do{if(!cursor)break;expansionStates.indexOf(""+nodeId)>=0&&cursor.removeClass("collapsed"),nodeId++;var next=null;if(!cursor.hasClass("collapsed")){var outline=cursor.children("ol");if(1==outline.length){var firstChild=outline.children(".concord-node:first");1==firstChild.length&&(next=firstChild)}}next||(next=this._walk_down(cursor)),cursor=next}while(null!=cursor)}return this.setTextMode(!1),flSetFocus&&this.setCursor(root.find(".concord-node:first")),root.data("currentChange",root.children().clone(!0,!0)),!0},this.attributes=new ConcordOpAttributes(concordInstance,this.getCursor())}var ConcordOpAttributes=require("./concord-op-attributes"),nil=null,infinity=Number.MAX_VALUE,down="down",left="left",right="right",up="up",flatup="flatup",flatdown="flatdown",nodirection="nodirection";module.exports=ConcordOp},{"./concord-op-attributes":4}],6:[function(require,module){function ConcordOutline(container,options,concord){this.container=container,this.options=options,this.id=null,this.root=null,this.editor=null,this.op=null,this.script=null,this.pasteBin=null,this.pasteBinFocus=function(){if(concord.ready&&!concord.mobile&&this.root.is(":visible")){var node=this.op.getCursor(),nodeOffset=node.offset();this.pasteBin.offset(nodeOffset),this.pasteBin.css("z-index","1000"),(""==this.pasteBin.text()||"\n"==this.pasteBin.text())&&this.pasteBin.text("..."),this.op.focusCursor(),this.pasteBin.focus(),this.pasteBin[0]===document.activeElement&&document.execCommand("selectAll")}},this.callbacks=function(callbacks){return callbacks?(this.root.data("callbacks",callbacks),callbacks):this.root.data("callbacks")?this.root.data("callbacks"):{}},this.fireCallback=function(name,value){var cb=this.callbacks()[name];cb&&cb(value)},this.prefs=function(newprefs){var prefs=this.root.data("prefs");if(void 0==prefs&&(prefs={}),newprefs){for(var key in newprefs)prefs[key]=newprefs[key];this.root.data("prefs",prefs),prefs.readonly&&this.root.addClass("readonly"),void 0!==prefs.renderMode&&this.root.data("renderMode",prefs.renderMode),prefs.contextMenu&&$(prefs.contextMenu).hide();var style={};prefs.outlineFont&&(style["font-family"]=prefs.outlineFont),prefs.outlineFontSize&&(prefs.outlineFontSize=parseInt(prefs.outlineFontSize),style["font-size"]=prefs.outlineFontSize+"px",style["min-height"]=prefs.outlineFontSize+6+"px",style["line-height"]=prefs.outlineFontSize+6+"px"),prefs.outlineLineHeight&&(prefs.outlineLineHeight=parseInt(prefs.outlineLineHeight),style["min-height"]=prefs.outlineLineHeight+"px",style["line-height"]=prefs.outlineLineHeight+"px"),this.root.parent().find("style.prefsStyle").remove();var css='<style type="text/css" class="prefsStyle">\n',cssId="";this.root.parent().attr("id")&&(cssId="#"+this.root.parent().attr("id")),css+=cssId+" .concord .concord-node .concord-wrapper .concord-text {";for(var attribute in style)css+=attribute+": "+style[attribute]+";";css+="}\n",css+=cssId+" .concord .concord-node .concord-wrapper .node-icon {";for(var attribute in style)"font-family"!=attribute&&(css+=attribute+": "+style[attribute]+";");css+="}\n";var wrapperPaddingLeft=prefs.outlineLineHeight;void 0===wrapperPaddingLeft&&(wrapperPaddingLeft=prefs.outlineFontSize),void 0!==wrapperPaddingLeft&&(css+=cssId+" .concord .concord-node .concord-wrapper {",css+="padding-left: "+wrapperPaddingLeft+"px",css+="}\n",css+=cssId+" .concord ol {",css+="padding-left: "+wrapperPaddingLeft+"px",css+="}\n"),css+="</style>\n",this.root.before(css),newprefs.css&&this.op.setStyle(newprefs.css)}return prefs},this.afterInit=function(){this.editor=new ConcordEditor(this.root,this),this.op=new ConcordOp(this.root,this),this.script=new ConcordScript(this.root,this),options&&(options.prefs&&this.prefs(options.prefs),options.open&&this.root.data("open",options.open),options.save&&this.root.data("save",options.save),options.callbacks&&this.callbacks(options.callbacks),options.id&&(this.root.data("id",options.id),this.open()))},this.init=function(){if($(container).find(".concord-root:first").length>0)return this.root=$(container).find(".concord-root:first"),this.pasteBin=$(container).find(".pasteBin:first"),void this.afterInit();var root=$("<ol></ol>");root.addClass("concord concord-root"),root.appendTo(container),this.root=root;var pasteBin=$('<div class="pasteBin" contenteditable="true" style="position: absolute; height: 1px; width:1px; outline:none; overflow:hidden;"></div>');pasteBin.appendTo(container),this.pasteBin=pasteBin,this.afterInit(),this.events=new ConcordEvents(this.root,this.editor,this.op,this)},this["new"]=function(){this.op.wipe()},this.open=function(cb){var opmlId=this.root.data("id");if(opmlId){var root=this.root,op=(this.editor,this.op),openUrl="http://concord.smallpicture.com/open";root.data("open")&&(openUrl=root.data("open")),params={},opmlId.match(/^http.+$/)?params.url=opmlId:params.id=opmlId,$.ajax({type:"POST",url:openUrl,data:params,dataType:"xml",success:function(opml){opml&&(op.xmlToOutline(opml),cb&&cb())},error:function(){0==root.find(".concord-node").length&&op.wipe()}})}},this.save=function(cb){var opmlId=this.root.data("id");if(opmlId&&this.op.changed()){var saveUrl="http://concord.smallpicture.com/save";this.root.data("save")&&(saveUrl=this.root.data("save"));var concordInstance=this,opml=this.op.outlineToXml();$.ajax({type:"POST",url:saveUrl,data:{opml:opml,id:opmlId},dataType:"json",success:function(json){concordInstance.op.clearChanged(),cb&&cb(json)}})}},this["import"]=function(opmlId,cb){var openUrl="http://concordold.smallpicture.com/open",root=this.root,concordInstance=this;root.data("open")&&(openUrl=root.data("open")),params={},opmlId.match(/^http.+$/)?params.url=opmlId:params.id=opmlId,$.ajax({type:"POST",url:openUrl,data:params,dataType:"xml",success:function(opml){if(opml){var cursor=root.find(".concord-cursor:first");$(opml).find("body").children("outline").each(function(){var node=concordInstance.editor.build($(this));cursor.after(node),cursor=node}),concordInstance.op.markChanged(),cb&&cb()}},error:function(){}})},this["export"]=function(){var context=this.root.find(".concord-cursor:first");return 0==context.length&&(context=this.root.find(".concord-root:first")),this.editor.opml(context)},this.init()}var ConcordEditor=require("./concord-editor"),ConcordOp=require("./concord-op"),ConcordScript=require("./concord-script"),ConcordEvents=require("./concord-events");module.exports=ConcordOutline},{"./concord-editor":2,"./concord-events":3,"./concord-op":5,"./concord-script":7}],7:[function(require,module){function ConcordScript(root,concordInstance){this.isComment=function(){if(void 0!==concordInstance.op.attributes.getOne("isComment"))return"true"==concordInstance.op.attributes.getOne("isComment");var parentIsAComment=!1;return concordInstance.op.getCursor().parents(".concord-node").each(function(){return"true"==concordInstance.op.setCursorContext($(this)).attributes.getOne("isComment")?void(parentIsAComment=!0):void 0}),parentIsAComment},this.makeComment=function(){return concordInstance.op.attributes.setOne("isComment","true"),concordInstance.op.getCursor().addClass("concord-comment"),!0},this.unComment=function(){return concordInstance.op.attributes.setOne("isComment","false"),concordInstance.op.getCursor().removeClass("concord-comment"),!0}}module.exports=ConcordScript},{}],8:[function(require,module){var ConcordOutline=require("./concord-outline"),concord={version:"3.0.0",mobile:/Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(navigator.userAgent),ready:!1,handleEvents:!0,resumeCallbacks:[],onResume:function(cb){this.resumeCallbacks.push(cb)},resumeListening:function(){if(!this.handleEvents){this.handleEvents=!0;var r=this.getFocusRoot();if(null!=r){var c=new ConcordOutline(r.parent(),null,concord);c.op.inTextMode()?(c.op.focusCursor(),c.editor.restoreSelection()):c.pasteBinFocus();for(var i in this.resumeCallbacks){var cb=this.resumeCallbacks[i];cb()}this.resumeCallbacks=[]}}},stopListening:function(){if(this.handleEvents){this.handleEvents=!1;var r=this.getFocusRoot();if(null!=r){var c=new ConcordOutline(r.parent(),null,concord);c.op.inTextMode()&&c.editor.saveSelection()}}},focusRoot:null,getFocusRoot:function(){return 1==$(".concord-root:visible").length?this.setFocusRoot($(".concord-root:visible:first")):$(".modal").is(":visible")&&1==$(".modal").find(".concord-root:visible:first").length?this.setFocusRoot($(".modal").find(".concord-root:visible:first")):null==this.focusRoot?$(".concord-root:visible").length>0?this.setFocusRoot($(".concord-root:visible:first")):null:this.focusRoot.is(":visible")?this.focusRoot:this.setFocusRoot($(".concord-root:visible:first"))},setFocusRoot:function(root){var origRoot=this.focusRoot,concordInstance=new ConcordOutline(root.parent(),null,concord);if(null!=origRoot&&origRoot[0]!==root[0]){var origConcordInstance=new ConcordOutline(origRoot.parent(),null,concord);origConcordInstance.editor.hideContextMenu(),origConcordInstance.editor.dragModeExit(),concordInstance.op.inTextMode()?concordInstance.op.focusCursor():concordInstance.pasteBinFocus()}return this.focusRoot=root,this.focusRoot},updateFocusRootEvent:function(event){var root=$(event.target).parents(".concord-root:first");1==root.length&&concord.setFocusRoot(root)}};module.exports=concord},{"./concord-outline":6}],9:[function(require){var concord=(require("./util"),require("./concord")),ConcordOutline=require("./concord-outline");$(function(){void 0!==$.fn.tooltip&&$("a[rel=tooltip]").tooltip({live:!0})}),$(function(){void 0!==$.fn.popover&&$("a[rel=popover]").on("mouseenter mouseleave",function(){$(this).popover("toggle")})}),Array.prototype.indexOf||(Array.prototype.indexOf=function(obj,start){for(var i=start||0,j=this.length;j>i;i++)if(this[i]===obj)return i;return-1});({version:concord.version});jQuery.fn.reverse=[].reverse;var down=(Number.MAX_VALUE,"down"),left="left",right="right",up="up";!function($){$.fn.concord=function(options){return new ConcordOutline($(this),options,concord)},$(document).on("keydown",function(event){if(concord.handleEvents&&!$(event.target).is("input")&&!$(event.target).is("textarea")){var focusRoot=concord.getFocusRoot();if(null!=focusRoot){var context=focusRoot;context.data("keydownEvent",event);var concordInstance=new ConcordOutline(context.parent(),null,concord),readonly=concordInstance.prefs().readonly;if(void 0==readonly&&(readonly=!1),readonly&&(event.which>=37&&event.which<=40?readonly=!1:(event.metaKey||event.ctrlKey)&&188==event.which&&(readonly=!1)),!readonly){concordInstance.fireCallback("opKeystroke",event);var keyCaptured=!1,commandKey=event.metaKey||event.ctrlKey;switch(event.which){case 8:concord.mobile?(""==concordInstance.op.getLineText()||"<br>"==concordInstance.op.getLineText())&&(event.preventDefault(),concordInstance.op.deleteLine()):concordInstance.op.inTextMode()?concordInstance.op.getCursor().hasClass("dirty")||(concordInstance.op.saveState(),concordInstance.op.getCursor().addClass("dirty")):(keyCaptured=!0,event.preventDefault(),concordInstance.op.deleteLine());break;case 9:keyCaptured=!0,event.preventDefault(),event.stopPropagation(),concordInstance.op.reorg(event.shiftKey?left:right);break;case 65:if(commandKey){keyCaptured=!0,event.preventDefault();var cursor=concordInstance.op.getCursor();concordInstance.op.inTextMode()?(concordInstance.op.focusCursor(),document.execCommand("selectAll",!1,null)):(concordInstance.editor.selectionMode(),cursor.parent().children().addClass("selected"))}break;case 85:commandKey&&(keyCaptured=!0,event.preventDefault(),concordInstance.op.reorg(up));break;case 68:commandKey&&(keyCaptured=!0,event.preventDefault(),concordInstance.op.reorg(down));break;case 76:commandKey&&(keyCaptured=!0,event.preventDefault(),concordInstance.op.reorg(left));break;case 82:commandKey&&(keyCaptured=!0,event.preventDefault(),concordInstance.op.reorg(right));break;case 219:commandKey&&(keyCaptured=!0,event.preventDefault(),concordInstance.op.promote());break;case 221:commandKey&&(keyCaptured=!0,event.preventDefault(),concordInstance.op.demote());break;case 13:if(concord.mobile){event.preventDefault(),keyCaptured=!0;var cursor=concordInstance.op.getCursor(),clonedCursor=cursor.clone(!0,!0);clonedCursor.removeClass("concord-cursor"),cursor.removeClass("selected"),cursor.removeClass("dirty"),cursor.removeClass("collapsed"),concordInstance.op.setLineText("");var icon='<i class="node-icon icon-caret-right"></i>';cursor.children(".concord-wrapper").children(".node-icon").replaceWith(icon),clonedCursor.insertBefore(cursor),concordInstance.op.attributes.makeEmpty(),concordInstance.op.deleteSubs(),concordInstance.op.focusCursor(),concordInstance.fireCallback("opInsert",concordInstance.op.setCursorContext(cursor))}else if(event.preventDefault(),keyCaptured=!0,event.originalEvent&&(event.originalEvent.keyLocation&&0!=event.originalEvent.keyLocation||event.originalEvent.location&&0!=event.originalEvent.location))concordInstance.op.setTextMode(!concordInstance.op.inTextMode());else{var direction=down;concordInstance.op.subsExpanded()&&(direction=right);var node=concordInstance.op.insert("",direction);concordInstance.op.setTextMode(!0),concordInstance.op.focusCursor()}break;case 37:var active=!1;if($(event.target).hasClass("concord-text")&&event.target.selectionStart>0&&(active=!1),1==context.find(".concord-cursor.selected").length&&(active=!0),active){keyCaptured=!0,event.preventDefault();var cursor=concordInstance.op.getCursor(),prev=concordInstance.op._walk_up(cursor);prev&&concordInstance.op.setCursor(prev)}break;case 38:if(keyCaptured=!0,event.preventDefault(),concordInstance.op.inTextMode()){var cursor=concordInstance.op.getCursor(),prev=concordInstance.op._walk_up(cursor);prev&&concordInstance.op.setCursor(prev)}else concordInstance.op.go(up,1,event.shiftKey,concordInstance.op.inTextMode());break;case 39:var active=!1;if(1==context.find(".concord-cursor.selected").length&&(active=!0),active){keyCaptured=!0,event.preventDefault();var next=null,cursor=concordInstance.op.getCursor();if(!cursor.hasClass("collapsed")){var outline=cursor.children("ol");if(1==outline.length){var firstChild=outline.children(".concord-node:first");1==firstChild.length&&(next=firstChild)}}next||(next=concordInstance.op._walk_down(cursor)),next&&concordInstance.op.setCursor(next)}break;case 40:if(keyCaptured=!0,event.preventDefault(),concordInstance.op.inTextMode()){var next=null,cursor=concordInstance.op.getCursor();if(!cursor.hasClass("collapsed")){var outline=cursor.children("ol");if(1==outline.length){var firstChild=outline.children(".concord-node:first");1==firstChild.length&&(next=firstChild)}}next||(next=concordInstance.op._walk_down(cursor)),next&&concordInstance.op.setCursor(next)}else concordInstance.op.go(down,1,event.shiftKey,concordInstance.op.inTextMode());break;case 46:concordInstance.op.inTextMode()?concordInstance.op.getCursor().hasClass("dirty")||(concordInstance.op.saveState(),concordInstance.op.getCursor().addClass("dirty")):(keyCaptured=!0,event.preventDefault(),concordInstance.op.deleteLine());break;case 90:commandKey&&(keyCaptured=!0,event.preventDefault(),concordInstance.op.undo());break;case 88:commandKey&&concordInstance.op.inTextMode()&&(""==concordInstance.op.getLineText()?(keyCaptured=!0,event.preventDefault(),concordInstance.op.deleteLine()):concordInstance.op.saveState());break;case 67:break;case 86:break;case 220:commandKey&&(concordInstance.script.isComment()?concordInstance.script.unComment():concordInstance.script.makeComment());break;case 73:commandKey&&(keyCaptured=!0,event.preventDefault(),concordInstance.op.italic());break;case 66:commandKey&&(keyCaptured=!0,event.preventDefault(),concordInstance.op.bold());break;case 192:commandKey&&(keyCaptured=!0,event.preventDefault(),concordInstance.op.setRenderMode(!concordInstance.op.getRenderMode()));break;case 188:commandKey&&(keyCaptured=!0,event.preventDefault(),concordInstance.op.subsExpanded()?concordInstance.op.collapse():concordInstance.op.expand());
break;case 191:commandKey&&(keyCaptured=!0,event.preventDefault(),concordInstance.op.runSelection());break;default:keyCaptured=!1}if(!keyCaptured&&event.which>=32&&(event.which<112||event.which>123)&&event.which<1e3&&!commandKey){var node=concordInstance.op.getCursor();concordInstance.op.inTextMode()?(node.hasClass("dirty")||concordInstance.op.saveState(),node.addClass("dirty")):(concordInstance.op.setTextMode(!0),concordInstance.op.saveState(),concordInstance.editor.edit(node,!0),node.addClass("dirty")),concordInstance.op.markChanged()}}}}}),$(document).on("mouseup",function(event){if(concord.handleEvents&&0!=$(".concord-root").length&&!($(event.target).is("a")||$(event.target).is("input")||$(event.target).is("textarea")||1==$(event.target).parents("a:first").length||$(event.target).hasClass("dropdown-menu")||$(event.target).parents(".dropdown-menu:first").length>0)){var context=$(event.target).parents(".concord-root:first");if(0==context.length){$(".concord-root").each(function(){var concordInstance=new ConcordOutline($(this).parent(),null,concord);concordInstance.editor.hideContextMenu(),concordInstance.editor.dragModeExit()});{concord.getFocusRoot()}}}}),$(document).on("click",concord.updateFocusRootEvent),$(document).on("dblclick",concord.updateFocusRootEvent),$(document).on("show",function(e){$(e.target).is(".modal")&&"true"!=$(e.target).attr("concord-events")&&concord.stopListening()}),$(document).on("hidden",function(e){$(e.target).is(".modal")&&"true"!=$(e.target).attr("concord-events")&&concord.resumeListening()}),concord.ready=!0}(jQuery)},{"./concord":8,"./concord-outline":6,"./util":10}],10:[function(require,module){var XML_CHAR_MAP={"<":"&lt;",">":"&gt;","&":"&amp;",'"':"&quot;"};module.exports={escapeXml:function(s){s=s.toString(),s=s.replace(/\u00A0/g," ");var escaped=s.replace(/[<>&"]/g,function(ch){return XML_CHAR_MAP[ch]});return escaped}}},{}]},{},[1]);